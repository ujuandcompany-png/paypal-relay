<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>uju & Co. PayPal Checkout</title>
<style>
  body { font-family: 'Dosis', sans-serif; padding: 20px; }
  h1 { text-align: center; font-family: 'Dosis', sans-serif; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; font-family: 'Dosis', sans-serif; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size:16px; }
  th { background: #f8f8f8; }
  tfoot td { font-weight: bold; }
  button { font-family: 'Dosis', sans-serif; font-size:16px; }
  .qtyBtn { width: 25px; height: 25px; text-align:center; line-height:1; cursor:pointer; border:1px solid #ccc; border-radius:4px; background:#f0f0f0; }
  .qtyNumber { width: 30px; text-align:center; display:inline-block; }
  .removeBtn { background:#dc3545; color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; }
  #paypal-button-container { margin-top:20px; text-align:center; }
  #updateMsg { display:block; background:#28a745; color:white; padding:10px 16px; border-radius:30px;
               font-size:16px; text-align:center; opacity:0; transition: opacity 0.5s ease; margin-top:10px; }
</style>
</head>
<body>
<h1>uju & Co. Checkout</h1>

<table id="cartTable">
  <thead>
    <tr>
      <th>Item</th>
      <th>Variant</th>
      <th>Qty</th>
      <th>Unit Price</th>
      <th>Total</th>
      <th>Remove</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="4">Grand Total</td>
      <td id="grandTotal">$0</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<div id="updateMsg">Cart updated!</div>
<div id="paypal-button-container"></div>

<script src="https://www.paypal.com/sdk/js?client-id=AYMMP5tG5xhXOMwg9VwtF2SNXhO1txVUk2USwhWO9lcyrUAMwZbdKQSqj2ZwfIUUa44RaHxxrWryePnD&currency=USD"></script>
<script>
if(!window.myCart) window.myCart = {};

// Parse query parameters to add new products
function parseQueryParams() {
  const params = new URLSearchParams(window.location.search);
  const names = params.getAll('item_name');
  const variants = params.getAll('os0');
  const quantities = params.getAll('quantity');
  const prices = params.getAll('amount');
  for(let i=0;i<names.length;i++){
    const key = variants[i] ? names[i] + '-' + variants[i] : names[i];
    const qty = parseInt(quantities[i]);
    const price = parseFloat(prices[i]);
    if(qty === 0) delete window.myCart[key];
    else {
      window.myCart[key] = { name:names[i], variant:variants[i]||'', qty, price };
    }
  }
}

// Update cart table
function renderCart(){
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML='';
  let grandTotal=0;
  for(const key in window.myCart){
    const item = window.myCart[key];
    const lineTotal = item.qty * item.price;
    grandTotal += lineTotal;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.variant}</td>
      <td>
        <button class="qtyBtn" onclick="adjustQty('${key}',-1)">−</button>
        <span class="qtyNumber">${item.qty}</span>
        <button class="qtyBtn" onclick="adjustQty('${key}',1)">+</button>
      </td>
      <td>$${item.price.toFixed(2)}</td>
      <td>$${lineTotal.toFixed(2)}</td>
      <td><button class="removeBtn" onclick="removeItem('${key}')">X</button></td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById('grandTotal').innerText=`$${grandTotal.toFixed(2)}`;
}

// Quantity adjustment
function adjustQty(key, change){
  if(window.myCart[key]){
    window.myCart[key].qty += change;
    if(window.myCart[key].qty <=0) delete window.myCart[key];
    renderCart();
    showUpdateMsg();
  }
}

// Remove item
function removeItem(key){
  delete window.myCart[key];
  renderCart();
  showUpdateMsg();
}

// Update message
function showUpdateMsg(){
  const msg = document.getElementById('updateMsg');
  msg.style.opacity='1';
  setTimeout(()=>{ msg.style.opacity='0'; },1500);
}

// Initialize
parseQueryParams();
renderCart();

// PayPal buttons
paypal.Buttons({
  style: { layout:'vertical', color:'gold', shape:'rect', label:'checkout' },
  createOrder: function(data, actions){
    const items = Object.values(window.myCart).map(i=>({
      name:`${i.name}${i.variant?' – '+i.variant:''}`,
      unit_amount:{ currency_code:'USD', value:i.price.toFixed(2) },
      quantity:i.qty
    }));
    const total = items.reduce((sum,i)=>sum + i.unit_amount.value*i.quantity,0).toFixed(2);
    return actions.order.create({
      purchase_units:[{
        amount:{ currency_code:'USD', value: total, breakdown:{ item_total:{ currency_code:'USD', value: total } } },
        items: items
      }],
      application_context: { brand_name:"uju & Co.", shipping_preference:"NO_SHIPPING" }
    });
  },
  onApprove:function(data, actions){
    return actions.order.capture().then(function(details){
      alert(`Transaction completed by ${details.payer.name.given_name}!`);
      window.myCart={};
      renderCart();
      window.close();
    });
  },
  onCancel:function(){ alert("Payment cancelled."); },
  onError:function(err){ console.error(err); alert("An error occurred during checkout."); }
}).render('#paypal-button-container');
</script>
</body>
</html>
