<!-- EGGSHELL VASE PRODUCT BUTTON SCRIPT -->
<div class="cart-wrapper" data-product-name="Eggshell Drying & Crushing Vase by uju" data-pid="7V8SBRAM7LYQS" data-price="50" data-limit="4">
  <label>Quantity</label>
  <select class="qtySelect">
    <option value="1" selected>1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="0">Delete item</option>
  </select>

  <button class="paybtn" onclick="addToPayPalCart(this)">ðŸ›’ Add to PayPal Cart</button>

  <div id="vaseUpdatedMsg" class="updateMsg">Please close the previous PayPal Cart Tab to refresh</div>
</div>

<style>
* { font-family: 'Dosis', sans-serif !important; font-size: 16px !important; }
.cart-wrapper { width: 100%; max-width: 400px; margin: 20px auto; }
.cart-wrapper label, .cart-wrapper select, .cart-wrapper button.paybtn { display: block; width: 100%; margin: 8px 0; }
.cart-wrapper select, .cart-wrapper button.paybtn { padding: 10px; border-radius: 6px; }
.cart-wrapper button.paybtn { background: #493b31; color: white; border: none; cursor: pointer; }
.cart-wrapper button.paybtn:hover { opacity: 0.85; }
.updateMsg { display: none; background: #28a745; color: white; padding: 5px 12px; margin-top: 10px; border-radius: 20px; font-size: 16px; width: max-content; white-space: nowrap; position: fixed; top: 20px; right: 20px; z-index: 9999; }
</style>

<script>
if(!window.myCart) window.myCart = {};
if(!window.paypalWindow) window.paypalWindow = null;

function addToPayPalCart(el){
  const wrap = el.closest('.cart-wrapper');
  const name = wrap.dataset.productName;
  const pid = wrap.dataset.pid;
  const price = parseFloat(wrap.dataset.price);
  const limit = parseInt(wrap.dataset.limit);
  const qty = parseInt(wrap.querySelector('.qtySelect').value);

  if(qty === 0){
    delete window.myCart[pid];
  } else {
    window.myCart[pid] = { name: name, qty: qty, price: price, limit: limit };
  }

  const relayPage = 'https://ujuandcompany-png.github.io/paypal-relay/paypal-relay.html';

  // Force numbers to string with 2 decimals and encode for URL
  const query = Object.values(window.myCart)
    .map(it => encodeURIComponent(it.name) + '|' + it.qty + '|' + encodeURIComponent(it.price.toFixed(2)))
    .join('&');

  const url = relayPage + '?' + query;

  try {
    if(!window.paypalWindow || window.paypalWindow.closed){
      window.paypalWindow = window.open(url, '_blank');
    } else {
      window.paypalWindow.focus();
      const msg = document.getElementById('vaseUpdatedMsg');
      msg.innerText = 'PayPal Cart Updated';
      msg.style.display = 'inline-block';
      setTimeout(()=>{ msg.style.display = 'none'; }, 2500);
      return;
    }
  } catch(e) {
    console.error('Failed to open PayPal window:', e);
    alert('Unable to open PayPal checkout tab. Please check popup settings.');
    return;
  }

  const msg = document.getElementById('vaseUpdatedMsg');
  msg.innerText = 'Please close the previous PayPal Cart Tab to refresh';
  msg.style.display = 'inline-block';
  setTimeout(()=>{ msg.style.display = 'none'; }, 2500);
}
</script>
