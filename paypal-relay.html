<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>uju & Co. PayPal Checkout</title>
<style>
  body { font-family: 'Dosis', sans-serif; background:#fff; padding:20px; color:#333; }
  h1 { text-align:center; margin-bottom:20px; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:left; }
  th { background:#f8f8f8; }
  tfoot td { font-weight:bold; }
  select.qtySelect { padding:6px 10px; border-radius:6px; font-family:'Dosis'; font-size:16px; }
  button.paybtn { 
    background:#493b31; color:white; border:none; cursor:pointer; 
    padding:12px 20px; border-radius:30px; font-family:'Dosis'; font-size:16px;
  }
  button.paybtn:hover { opacity:0.85; }
  #cartUpdatedMsg { 
    display:block; background:#28a745; color:white; padding:10px 16px; 
    border-radius:30px; font-size:16px; margin-bottom:10px; opacity:0; 
    transition:opacity 0.5s ease; text-align:center;
  }
</style>
</head>
<body>

<h1>Shopping Cart - uju & Co.</h1>
<div id="cartUpdatedMsg">Cart updated!</div>

<table id="cartTable">
  <thead>
    <tr>
      <th>Item</th>
      <th>Variant</th>
      <th>Qty</th>
      <th>Unit Price</th>
      <th>Total</th>
      <th>Remove</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="4">Grand Total</td>
      <td id="grandTotal">$0</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<div style="text-align:center; margin-top:20px;">
  <button id="checkoutBtn" class="paybtn">ðŸ›’ Checkout with PayPal</button>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=AYMMP5tG5xhXOMwg9VwtF2SNXhO1txVUk2USwhWO9lcyrUAMwZbdKQSqj2ZwfIUUa44RaHxxrWryePnD&currency=USD"></script>
<script>
const cartMsg = document.getElementById('cartUpdatedMsg');

// 1. Load cart from localStorage or URL
function getCartFromURLorStorage(){
  const params = new URLSearchParams(window.location.search);
  let cart = localStorage.getItem('paypalCart') ? JSON.parse(localStorage.getItem('paypalCart')) : {};

  if(params.get('cart')){
    try{
      const urlCart = JSON.parse(decodeURIComponent(params.get('cart')));
      cart = {...cart, ...urlCart}; // Merge
      localStorage.setItem('paypalCart', JSON.stringify(cart));
    }catch(e){ console.error(e); }
  }
  return cart;
}

// 2. Render cart table
function renderCart(){
  const cart = getCartFromURLorStorage();
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML='';
  let grandTotal = 0;

  Object.keys(cart).forEach(key=>{
    const item = cart[key];
    const lineTotal = item.price * item.qty;
    grandTotal += lineTotal;

    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${item.name}</td>
      <td>${item.variant || ''}</td>
      <td>
        <select class="qtySelect">
          ${[...Array(10)].map((_,i)=>`<option value="${i+1}" ${i+1===item.qty?'selected':''}>${i+1}</option>`).join('')}
        </select>
      </td>
      <td>$${item.price.toFixed(2)}</td>
      <td>$${lineTotal.toFixed(2)}</td>
      <td><button class="paybtn removeBtn">X</button></td>
    `;
    tbody.appendChild(tr);

    tr.querySelector('.qtySelect').addEventListener('change', e=>{
      item.qty = parseInt(e.target.value);
      localStorage.setItem('paypalCart', JSON.stringify(cart));
      renderCart();
      showCartMsg();
    });

    tr.querySelector('.removeBtn').addEventListener('click', ()=>{
      delete cart[key];
      localStorage.setItem('paypalCart', JSON.stringify(cart));
      renderCart();
      showCartMsg();
    });
  });

  document.getElementById('grandTotal').innerText = `$${grandTotal.toFixed(2)}`;
}

// 3. Show cart updated message
function showCartMsg(){
  cartMsg.style.opacity=1;
  setTimeout(()=>{ cartMsg.style.opacity=0; },1500);
}

// 4. PayPal Checkout
document.getElementById('checkoutBtn').addEventListener('click', ()=>{
  const cart = getCartFromURLorStorage();
  const grandTotal = Object.values(cart).reduce((sum,i)=>sum+i.price*i.qty,0);
  if(grandTotal<=0){ alert('Cart is empty'); return; }

  paypal.Buttons({
    style: { layout:'vertical', color:'gold', shape:'rect', label:'checkout' },
    createOrder: (data, actions) => actions.order.create({
      purchase_units:[{
        amount: { currency_code:'USD', value:grandTotal.toFixed(2),
                  breakdown:{ item_total:{currency_code:'USD', value:grandTotal.toFixed(2)} } },
        items: Object.values(cart).map(i=>({
          name: i.name + (i.variant?' - '+i.variant:''),
          unit_amount: { currency_code:'USD', value:i.price.toFixed(2) },
          quantity: i.qty
        }))
      }],
      application_context:{ brand_name:"uju & Co.", shipping_preference:"NO_SHIPPING" }
    }),
    onApprove: (data, actions) => actions.order.capture().then(details=>{
      alert(`Transaction completed by ${details.payer.name.given_name}!`);
      localStorage.removeItem('paypalCart');
      window.location.reload();
    }),
    onCancel: ()=>alert('Payment cancelled.'),
    onError: err=>{ console.error(err); alert('Error during checkout'); }
  }).render('body');
});

renderCart();
</script>
</body>
</html>
