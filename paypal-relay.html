<script src="https://www.paypal.com/sdk/js?client-id=AYMMP5tG5xhXOMwg9VwtF2SNXhO1txVUk2USwhWO9lcyrUAMwZbdKQSqj2ZwfIUUa44RaHxxrWryePnD&currency=USD"></script>
<script>
// 1. Load existing cart from localStorage
let cart = localStorage.getItem('paypalCart') ? JSON.parse(localStorage.getItem('paypalCart')) : {};

// 2. Merge incoming cart from URL parameter (if any)
const params = new URLSearchParams(window.location.search);
if(params.has('cart')){
  try {
    const incoming = JSON.parse(decodeURIComponent(params.get('cart')));
    for(const key in incoming){
      // If the item already exists, sum quantities
      if(cart[key]) cart[key].qty += incoming[key].qty;
      else cart[key] = incoming[key];
    }
    localStorage.setItem('paypalCart', JSON.stringify(cart));
  } catch(e){ console.error('Invalid cart parameter', e); }
}

// 3. Render cart table
const tbody = document.querySelector('#cartTable tbody');
function renderCart(){
  tbody.innerHTML = '';
  let grandTotal = 0;
  for(const key in cart){
    const item = cart[key];
    const lineTotal = item.qty * item.price;
    grandTotal += lineTotal;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.variant || ''}</td>
      <td>
        <button onclick="adjustQty('${key}',-1)">âˆ’</button>
        ${item.qty}
        <button onclick="adjustQty('${key}',1)">+</button>
      </td>
      <td>$${item.price.toFixed(2)}</td>
      <td>$${lineTotal.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById('grandTotal').innerText = `$${grandTotal.toFixed(2)}`;
}

function adjustQty(key, change){
  if(cart[key]){
    cart[key].qty += change;
    if(cart[key].qty <=0) delete cart[key];
    localStorage.setItem('paypalCart', JSON.stringify(cart));
    renderCart();
  }
}

renderCart();

// 4. PayPal Buttons
paypal.Buttons({
  style: { layout:'vertical', color:'gold', shape:'rect', label:'checkout' },
  createOrder: function(data, actions){
    const purchaseItems = [];
    let totalAmount = 0;
    for(const k in cart){
      const i = cart[k];
      purchaseItems.push({
        name: i.name + (i.variant ? ' - ' + i.variant : ''),
        unit_amount: { currency_code:'USD', value:i.price.toFixed(2) },
        quantity: i.qty
      });
      totalAmount += i.price * i.qty;
    }
    return actions.order.create({
      purchase_units:[{
        amount: { currency_code:'USD', value: totalAmount.toFixed(2), breakdown:{ item_total:{ currency_code:'USD', value: totalAmount.toFixed(2) } } },
        items: purchaseItems
      }],
      application_context:{ brand_name:"uju & Co.", shipping_preference:"NO_SHIPPING" }
    });
  },
  onApprove: function(data, actions){
    return actions.order.capture().then(details=>{
      alert(`Transaction completed by ${details.payer.name.given_name}!`);
      localStorage.removeItem('paypalCart');
      renderCart();
      window.close();
    });
  },
  onCancel: function(){ alert("Payment cancelled."); },
  onError: function(err){ console.error(err); alert("Checkout error."); }
}).render('#paypal-button-container');
</script>
