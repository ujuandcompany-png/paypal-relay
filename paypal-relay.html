<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>uju & Co. PayPal Checkout</title>
<style>
  body { font-family: 'Dosis', sans-serif; padding: 20px; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f8f8f8; }
  tfoot td { font-weight: bold; }
  #paypal-button-container { margin-top: 20px; text-align: center; }
</style>
</head>
<body>
<h1>uju & Co. PayPal Checkout</h1>
<table id="cartTable">
  <thead>
    <tr>
      <th>Item</th>
      <th>Variant</th>
      <th>Qty</th>
      <th>Unit Price</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="4">Total</td>
      <td id="grandTotal">$0</td>
    </tr>
  </tfoot>
</table>

<div id="paypal-button-container"></div>

<script src="https://www.paypal.com/sdk/js?client-id=AYMMP5tG5xhXOMwg9VwtF2SNXhO1txVUk2USwhWO9lcyrUAMwZbdKQSqj2ZwfIUUa44RaHxxrWryePnD&currency=USD"></script>
<script>
function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  const items = [];
  let index = 0;
  while(params.has('item_name')) {
    items.push({
      name: params.getAll('item_name')[index],
      variant: params.getAll('os0')[index],
      quantity: parseInt(params.getAll('quantity')[index]),
      unitPrice: parseFloat(params.getAll('amount')[index])
    });
    index++;
    if(index >= params.getAll('item_name').length) break;
  }
  return items;
}

// Render item table
const items = getQueryParams();
const tbody = document.querySelector('#cartTable tbody');
let grandTotal = 0;

items.forEach(item=>{
  const lineTotal = item.quantity * item.unitPrice;
  grandTotal += lineTotal;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${item.name}</td>
    <td>${item.variant}</td>
    <td>${item.quantity}</td>
    <td>$${item.unitPrice.toFixed(2)}</td>
    <td>$${lineTotal.toFixed(2)}</td>
  `;
  tbody.appendChild(tr);
});
document.getElementById('grandTotal').innerText = `$${grandTotal.toFixed(2)}`;

// PayPal Buttons
paypal.Buttons({
  style: {
    layout: 'vertical',
    color: 'gold',
    shape: 'rect',
    label: 'checkout'
  },
  createOrder: function(data, actions) {
    return actions.order.create({
      purchase_units: [{
        amount: {
          currency_code: 'USD',
          value: grandTotal.toFixed(2),
          breakdown: {
            item_total: { currency_code: 'USD', value: grandTotal.toFixed(2) }
          }
        },
        items: items.map(i=>({
          name: `${i.name} â€“ ${i.variant}`,
          unit_amount: { currency_code: 'USD', value: i.unitPrice.toFixed(2) },
          quantity: i.quantity
        }))
      }],
      application_context: {
        brand_name: "uju & Co.",
        shipping_preference: "NO_SHIPPING"
      }
    });
  },
  onApprove: function(data, actions) {
    return actions.order.capture().then(function(details) {
      alert(`Transaction completed by ${details.payer.name.given_name}!`);
      window.close(); // close the relay tab after successful payment
    });
  },
  onCancel: function() {
    alert("Payment cancelled.");
  },
  onError: function(err) {
    console.error(err);
    alert("An error occurred during checkout.");
  }
}).render('#paypal-button-container');
</script>
</body>
</html>
